function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  if (sheet.getName() !== 'Students') return;

  const theaterSheet = e.source.getSheetByName('Theater');
  const musicSheet = e.source.getSheetByName('Music');
  const roboticsSheet = e.source.getSheetByName('Robotics');

  const editedRows = e.range.getNumRows();

  distributeStudents(sheet, theaterSheet, editedRows);
  distributeStudents(sheet, musicSheet, editedRows);
  distributeStudents(sheet, roboticsSheet, editedRows);

 

  // Loop over edited rows
  /*
  for (let r = 0; r < editedRows; r++) {
    const row = e.range.getRow() + r;
    if (row < 2) continue; // skip header

    const email = sheet.getRange(row, 1).getValue();
    const student = sheet.getRange(row, 2).getValue();
    const clubs = sheet.getRange(row, 5).getValue();

    // Fetch current Theater emails each iteration
    const lastRow = theaterSheet.getLastRow();
    const theaterEmails = lastRow > 1
      ? theaterSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat()
      : [];

    // Add student if they selected Theater
    if (clubs && clubs.toString().includes('Theater')) {
      if (!theaterEmails.includes(email)) {
        theaterSheet.appendRow([email, student, '', '', '', '']);
      }
    } 
    // Remove student if they deselected Theater
    else {
      // Loop bottom-to-top to avoid skipping rows
      for (let i = theaterEmails.length - 1; i >= 0; i--) {
        if (theaterEmails[i] === email) {
          theaterSheet.deleteRow(i + 2); // +2 for header
        }
      }
    }
  }

  // ----- Remove completely deleted students -----
  const studentEmails = sheet.getRange(2, 1, Math.max(sheet.getLastRow() - 1, 0), 1)
    .getValues().flat();

  const lastRow = theaterSheet.getLastRow();
  if (lastRow > 1) {
    const theaterEmails = theaterSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    for (let i = theaterEmails.length - 1; i >= 0; i--) {
      if (!studentEmails.includes(theaterEmails[i])) {
        theaterSheet.deleteRow(i + 2);
      }
    }
  }
  */
}

function distributeStudents(studentsSheet, destinationSheet, editedRows) {
  // Loop over edited rows
  for (let r = 0; r < editedRows; r++) {
    const row = e.range.getRow() + r;
    if (row < 2) continue; // skip header

    const email = studentsSheet.getRange(row, 1).getValue();
    const student = studentsSheet.getRange(row, 2).getValue();
    const clubs = studentsSheet.getRange(row, 5).getValue();

    // Fetch current Theater emails each iteration
    const lastRow = destinationSheet.getLastRow();
    const theaterEmails = lastRow > 1
      ? destinationSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat()
      : [];

    // Add student if they selected Theater
    if (clubs && clubs.toString().includes('Theater')) {
      if (!theaterEmails.includes(email)) {
        destinationSheet.appendRow([email, student, '', '', '', '']);
      }
    } 
    // Remove student if they deselected Theater
    else {
      // Loop bottom-to-top to avoid skipping rows
      for (let i = theaterEmails.length - 1; i >= 0; i--) {
        if (theaterEmails[i] === email) {
          destinationSheet.deleteRow(i + 2); // +2 for header
        }
      }
    }
  }

  // ----- Remove completely deleted students -----
  const studentEmails = studentsSheet.getRange(2, 1, Math.max(studentsSheet.getLastRow() - 1, 0), 1)
    .getValues().flat();

  const lastRow = destinationSheet.getLastRow();
  if (lastRow > 1) {
    const theaterEmails = destinationSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    for (let i = theaterEmails.length - 1; i >= 0; i--) {
      if (!studentEmails.includes(theaterEmails[i])) {
        theaterSheet.deleteRow(i + 2);
      }
    }
  }

}
